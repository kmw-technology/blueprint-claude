# =============================================================================
# CI Pipeline - {{PROJECT_NAME}}
# =============================================================================
# Anpassen: SOLUTION_NAME, DOTNET_VERSION, Database-Config nach Bedarf

name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  # Anpassen an Projekt
  SOLUTION_NAME: '{{PROJECT_NAME}}.sln'
  DOTNET_VERSION: '8.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_NAME }}

    - name: Build
      run: dotnet build ${{ env.SOLUTION_NAME }} --configuration Release --no-restore --warnaserror

    - name: Check formatting
      run: dotnet format ${{ env.SOLUTION_NAME }} --verify-no-changes --verbosity diagnostic
      continue-on-error: true  # Warning only initially

  test:
    runs-on: ubuntu-latest
    needs: build

    # Datenbank-Service (anpassen nach Bedarf)
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore ${{ env.SOLUTION_NAME }}

    - name: Run Unit Tests
      run: |
        dotnet test ${{ env.SOLUTION_NAME }} \
          --filter "Category!=Integration" \
          --configuration Release \
          --no-restore \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults \
          --logger "trx;LogFileName=unit-tests.trx"

    - name: Run Integration Tests
      run: |
        dotnet test ${{ env.SOLUTION_NAME }} \
          --filter "Category=Integration" \
          --configuration Release \
          --no-restore \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults \
          --logger "trx;LogFileName=integration-tests.trx"
      env:
        ConnectionStrings__Default: "Host=localhost;Database=test_db;Username=test_user;Password=test_password"

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: ./TestResults

    - name: Generate Coverage Report
      uses: danielpalme/ReportGenerator-GitHub-Action@5
      with:
        reports: './TestResults/**/coverage.cobertura.xml'
        targetdir: './CoverageReport'
        reporttypes: 'Html;Cobertura;Badges'

    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: ./CoverageReport

    - name: Check coverage threshold
      run: |
        # Extract coverage and check against 70% threshold
        COVERAGE=$(grep -oP 'line-rate="\K[^"]+' ./TestResults/**/coverage.cobertura.xml | head -1 | awk '{print $1 * 100}')
        echo "Coverage: $COVERAGE%"
        if (( $(echo "$COVERAGE < 70" | bc -l) )); then
          echo "::error::Coverage is below 70% threshold!"
          # Uncomment when coverage is established:
          # exit 1
        fi

  security-scan:
    runs-on: ubuntu-latest
    needs: build

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Check for vulnerable packages
      run: |
        dotnet list ${{ env.SOLUTION_NAME }} package --vulnerable --include-transitive
      continue-on-error: true  # Warning only initially
